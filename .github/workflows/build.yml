name: Build Thunderbird Extension

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version consistency (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Extract version from tag (v0.7.8 -> 0.7.8)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          # Get versions from files
          MANIFEST_VERSION=$(jq -r '.version' resources/manifest.json)
          PACKAGE_VERSION=$(jq -r '.version' package.json)

          echo "Tag version: $TAG_VERSION"
          echo "Manifest version: $MANIFEST_VERSION"
          echo "Package.json version: $PACKAGE_VERSION"

          # Check if all versions match
          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "❌ Error: Tag version ($TAG_VERSION) does not match manifest.json version ($MANIFEST_VERSION)"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "❌ Error: Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)"
            exit 1
          fi

          echo "✅ All versions match: $TAG_VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build extension
        run: yarn run grunt release

      - name: Get version from manifest
        id: version
        run: |
          VERSION=$(jq -r '.version' resources/manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=postguard-tb-addon-$VERSION.xpi" >> $GITHUB_OUTPUT

      - name: Update updates.json with GitHub release URL
        run: |
          VERSION=$(jq -r '.version' resources/manifest.json)
          STRICT_MIN=$(jq -r '.browser_specific_settings.gecko.strict_min_version // "102.0"' resources/manifest.json)
          STRICT_MAX=$(jq -r '.browser_specific_settings.gecko.strict_max_version' resources/manifest.json)

          # Read existing updates.json from dist
          UPDATES_JSON="dist/updates.json"

          # Update updates.json with GitHub release URL
          jq \
            --arg version "$VERSION" \
            --arg url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/postguard-tb-addon-$VERSION.xpi" \
            --arg min "$STRICT_MIN" \
            --arg max "$STRICT_MAX" \
            '
            .addons["pg4tb@e4a.org"].updates += [{
              version: $version,
              update_link: $url,
              applications: {
                gecko: {
                  strict_min_version: $min,
                  strict_max_version: $max
                }
              }
            }] |
            .addons["pg4tb@e4a.org"].updates |= unique_by(.version)
            ' \
            "$UPDATES_JSON" > "${UPDATES_JSON}.tmp"

          mv "${UPDATES_JSON}.tmp" "$UPDATES_JSON"

          echo "Updated updates.json with version $VERSION"
          cat "$UPDATES_JSON"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: postguard-tb-addon-${{ steps.version.outputs.version }}
          path: |
            dist/postguard-tb-addon-${{ steps.version.outputs.version }}.xpi
            dist/updates.json
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from manifest
        id: version
        run: |
          VERSION=$(jq -r '.version' resources/manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=postguard-tb-addon-$VERSION.xpi" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: postguard-tb-addon-${{ steps.version.outputs.version }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            postguard-tb-addon-${{ steps.version.outputs.version }}.xpi
            updates.json
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
